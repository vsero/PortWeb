@page "/shipmentList"
@using Vsero.PortTrack.Components
@using LC = Vsero.PortTrack.Resources.LCommon
@using Vsero.UTrcak.V1
@inject ApiClient Api
@inject UserContext UserContext
@inherits PortTrackComponentBase



<MudContainer MaxWidth="MaxWidth.Medium" Class="pa-4">

    <ErrorAlertBar ErrorMessage="@_errorMessage" />
    <PageLoading IsLoading="@_isLoading" />

    @if (!_shipments.Any() && !_isLoading && String.IsNullOrEmpty(_errorMessage))
    {
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="min-height: 60vh;">
            <MudIcon Icon="@Icons.Material.Filled.Inventory"
                     Style="font-size: 8rem;"
                     Color="Color.Default"
                     Class="mb-4 opacity-50" />
            <MudText Typo="Typo.h5" Align="Align.Center" Color="Color.Default" Class="mud-text-secondary" Style="white-space: pre-line;">
                @LC.Label_NoShipmentsAdded
            </MudText>
        </MudStack>
    }

    <MudStack Spacing="1">
        @foreach (var shipment in _shipments)
        {
            <ShipmentCard @key="shipment" Shipment="shipment" IsExpandable="true">
                <CardActions>
                    @if (UserContext.IsTg)
                    {
                        <MudSpacer />
                        <ShipmentCardButton OnClick="@(() => ShipmentCard_Delete(shipment))" Kind="ShipmentCardButton.ButtonKind.Delete" />
                    }
                </CardActions>
            </ShipmentCard>
        }
    </MudStack>

</MudContainer>




@code {

    private bool _isLoading;
    private string _errorMessage = string.Empty;
    private List<CargoShipment> _shipments = [];



    protected override Task OnInitializedAsync()
    {
        _ = GetShipments();
        return base.OnInitializedAsync();
    }



    private async Task GetShipments()
    {
        _isLoading = true;
        _errorMessage = string.Empty;
        _shipments.Clear();

        IEnumerable<CargoShipment>? cargoShipments = null;
        var apiTguser = UserContext.ApiTguser();
        if (apiTguser is not null)
        {
            (cargoShipments, _errorMessage) = await Api.NotifyShipmentGetAsync(apiTguser, CancellationToken());
        }

        if (cargoShipments is not null)
            _shipments = cargoShipments.ToList();

        _isLoading = false;
        StateHasChanged();
    }



    private async Task ShipmentCard_Delete(CargoShipment shipment)
    {
        bool result = false;
        var apiTguser = UserContext.ApiTguser();
        if (apiTguser is not null)
        {
            (result, _errorMessage) = await Api.NotifyShipmentDeleteAsync(apiTguser, shipment, CancellationToken());
        }

        if (_shipments.Contains(shipment))
            _shipments.Remove(shipment);
    }

}